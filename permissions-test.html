<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permissions Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
            background: #1976d2;
            color: white;
        }
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .permission-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .permission-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .permission-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .permission-item:last-child {
            border-bottom: none;
        }
        .permission-name {
            font-size: 14px;
            color: #666;
        }
        .permission-value {
            font-weight: 500;
        }
        .permission-true {
            color: #4caf50;
        }
        .permission-false {
            color: #f44336;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .active-role {
            background: #4caf50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Permissions Test</h1>
        <p>This page tests your user permissions and role-based access.</p>
        
        <div id="userInfo" class="user-info">
            <h3>Loading user info...</h3>
        </div>

        <div id="roleSwitcher">
            <h3>Role Switcher</h3>
            <div id="roleButtons"></div>
        </div>

        <div id="permissionsDisplay">
            <h3>Current Role Permissions</h3>
            <div id="permissionCards"></div>
        </div>

        <button onclick="testPermissions()">Test Permissions</button>
        <button onclick="switchRole('ADMINISTRATOR')">Switch to Admin</button>
        <button onclick="switchRole('LANDLORD')">Switch to Landlord</button>
        <button onclick="switchRole('TENANT')">Switch to Tenant</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBiANBFBL0K4v36ZSYD_wS7uGdRsQIbC-A",
            authDomain: "letzpocket-site.firebaseapp.com",
            projectId: "letzpocket-site",
            storageBucket: "letzpocket-site.firebasestorage.app",
            messagingSenderId: "557937099852",
            appId: "1:557937099852:web:b3dfab6dac35efb51ae0e9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Role permissions (matching your app)
        const ROLE_PERMISSIONS = {
            TENANT: {
                canViewOwnTenancy: true,
                canSubmitDocuments: true,
                canViewReports: true,
                canManageProperties: false,
                canManageAllUsers: false,
                canAccessSystemSettings: false,
                canOverridePermissions: false,
                canViewAllData: false,
                canProcessDocuments: false,
                canManageWorkflows: false,
                canCommunicateWithUsers: false,
                canViewAssignedTasks: false,
                canViewOwnProperties: false,
                canManageTenancies: false,
                canGenerateReports: false,
                canViewAnalytics: false
            },
            LANDLORD: {
                canViewOwnTenancy: false,
                canSubmitDocuments: true,
                canViewReports: true,
                canManageProperties: true,
                canManageAllUsers: false,
                canAccessSystemSettings: false,
                canOverridePermissions: false,
                canViewAllData: false,
                canProcessDocuments: false,
                canManageWorkflows: false,
                canCommunicateWithUsers: false,
                canViewAssignedTasks: false,
                canViewOwnProperties: true,
                canManageTenancies: true,
                canGenerateReports: true,
                canViewAnalytics: true
            },
            ADMINISTRATOR: {
                canViewOwnTenancy: true,
                canSubmitDocuments: true,
                canViewReports: true,
                canManageProperties: true,
                canManageAllUsers: true,
                canAccessSystemSettings: true,
                canOverridePermissions: true,
                canViewAllData: true,
                canProcessDocuments: true,
                canManageWorkflows: true,
                canCommunicateWithUsers: true,
                canViewAssignedTasks: true,
                canViewOwnProperties: true,
                canManageTenancies: true,
                canGenerateReports: true,
                canViewAnalytics: true
            },
            OPERATOR: {
                canViewOwnTenancy: false,
                canSubmitDocuments: false,
                canViewReports: true,
                canManageProperties: false,
                canManageAllUsers: false,
                canAccessSystemSettings: false,
                canOverridePermissions: false,
                canViewAllData: false,
                canProcessDocuments: true,
                canManageWorkflows: true,
                canCommunicateWithUsers: true,
                canViewAssignedTasks: true,
                canViewOwnProperties: false,
                canManageTenancies: false,
                canGenerateReports: false,
                canViewAnalytics: false
            }
        };

        let currentUser = null;
        let currentActiveRole = null;

        async function loadUserInfo() {
            try {
                // Get current authenticated user
                const firebaseUser = auth.currentUser;
                if (!firebaseUser) {
                    document.getElementById('userInfo').innerHTML = '<h3>‚ùå No user logged in</h3><p>Please log in to LetzPocket first.</p>';
                    return;
                }

                // Get user profile from Firestore
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                if (!userDoc.exists) {
                    document.getElementById('userInfo').innerHTML = '<h3>‚ùå User profile not found</h3><p>Your user profile doesn\'t exist in Firestore.</p>';
                    return;
                }

                currentUser = userDoc.data();
                currentActiveRole = currentUser.activeRole;

                displayUserInfo();
                displayRoleSwitcher();
                displayPermissions();
                
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('userInfo').innerHTML = `<h3>‚ùå Error loading user info</h3><p>${error.message}</p>`;
            }
        }

        function displayUserInfo() {
            const rolesHtml = currentUser.roles.map(role => 
                `<span class="role-badge">${role}</span>`
            ).join('');

            document.getElementById('userInfo').innerHTML = `
                <h3>üë§ User Information</h3>
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>Name:</strong> ${currentUser.displayName || 'N/A'}</p>
                <p><strong>Roles:</strong> ${rolesHtml}</p>
                <p><strong>Active Role:</strong> <span class="role-badge active-role">${currentActiveRole}</span></p>
                <p><strong>User ID:</strong> ${currentUser.uid}</p>
            `;
        }

        function displayRoleSwitcher() {
            const roleButtons = currentUser.roles.map(role => `
                <button 
                    onclick="switchRole('${role}')" 
                    class="${role === currentActiveRole ? 'active-role' : ''}"
                >
                    Switch to ${role}
                </button>
            `).join('');

            document.getElementById('roleButtons').innerHTML = roleButtons;
        }

        function displayPermissions() {
            const permissions = ROLE_PERMISSIONS[currentActiveRole];
            const permissionCards = Object.entries(permissions).map(([permission, value]) => `
                <div class="permission-item">
                    <span class="permission-name">${permission}</span>
                    <span class="permission-value ${value ? 'permission-true' : 'permission-false'}">
                        ${value ? '‚úÖ Granted' : '‚ùå Denied'}
                    </span>
                </div>
            `).join('');

            document.getElementById('permissionCards').innerHTML = `
                <div class="permission-card">
                    <h3>${currentActiveRole} Permissions</h3>
                    ${permissionCards}
                </div>
            `;
        }

        async function switchRole(newRole) {
            if (!currentUser) return;

            try {
                // Update active role in Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    activeRole: newRole,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });

                currentActiveRole = newRole;
                currentUser.activeRole = newRole;

                displayUserInfo();
                displayRoleSwitcher();
                displayPermissions();

                console.log(`‚úÖ Switched to ${newRole} role`);
            } catch (error) {
                console.error('‚ùå Failed to switch role:', error);
                alert(`Failed to switch role: ${error.message}`);
            }
        }

        function testPermissions() {
            if (!currentUser) {
                alert('Please load user info first');
                return;
            }

            console.log('üîç Testing permissions for:', currentUser.email);
            console.log('üìã Available roles:', currentUser.roles);
            console.log('üéØ Active role:', currentActiveRole);
            console.log('üîê Current permissions:', ROLE_PERMISSIONS[currentActiveRole]);

            // Test specific admin permissions
            const adminPerms = ['canManageAllUsers', 'canAccessSystemSettings', 'canOverridePermissions'];
            const landlordPerms = ['canManageProperties', 'canManageTenancies', 'canViewAnalytics'];
            
            console.log('üëë Admin permissions check:');
            adminPerms.forEach(perm => {
                const has = ROLE_PERMISSIONS[currentActiveRole][perm];
                console.log(`  ${perm}: ${has ? '‚úÖ' : '‚ùå'}`);
            });

            console.log('üè† Landlord permissions check:');
            landlordPerms.forEach(perm => {
                const has = ROLE_PERMISSIONS[currentActiveRole][perm];
                console.log(`  ${perm}: ${has ? '‚úÖ' : '‚ùå'}`);
            });
        }

        // Load user info when page loads
        window.onload = function() {
            loadUserInfo();
        };
    </script>
</body>
</html>
